{"version":3,"file":"ucamera-overlay.js","sources":["ucamera-overlay.vue","RDovd29ya3NwYWNlL0NsaWVudFdvcmtBcmVhL-ivgeeFp-Wwj-eoi-W6jy9taW5pYXBwL3pmYi11bmlhcHAvY29tcG9uZW50cy91Y2FtZXJhLW92ZXJsYXkvdWNhbWVyYS1vdmVybGF5LnZ1ZQ"],"sourcesContent":["<template>\n  <view class=\"ucam-root\">\n    <camera\n      id=\"ucam\"\n      class=\"ucam-camera\"\n      :device-position=\"currentDevice\"\n      flash=\"off\"\n      mode=\"normal\"\n      resolution=\"high\"\n      frame-size=\"small\"\n      @ready=\"onCamReady\"\n    ></camera>\n\n    <!-- 支付宝小程序：用原生 canvas 作为相机上的可覆盖层 -->\n    <!-- #ifdef MP-ALIPAY -->\n    <canvas\n      class=\"ucam-overlay\"\n      :canvas-id=\"canvasId\"\n      :id=\"canvasId\"\n    ></canvas>\n\n    <!-- 将按钮放在 cover-view（可盖在 canvas 上） -->\n    <cover-view class=\"ucam-hud\" v-if=\"showControls\">\n      <cover-view class=\"ucam-tips\" v-if=\"tips\">{{ tips }}</cover-view>\n      <cover-view class=\"ucam-btns\">\n        <cover-view class=\"ucam-btn\" @tap=\"onShutter\">拍照</cover-view>\n        <cover-view class=\"ucam-btn\" @tap=\"toggleDevice\">前/后</cover-view>\n        <cover-view class=\"ucam-btn\" @tap=\"zoomIn\">放大</cover-view>\n      </cover-view>\n    </cover-view>\n    <!-- #endif -->\n\n    <!-- 其它端给出提示 -->\n    <!-- #ifndef MP-ALIPAY -->\n    <view class=\"ucam-notice\">此组件的 HUD 仅在支付宝小程序端启用</view>\n    <!-- #endif -->\n  </view>\n</template>\n\n<script>\nexport default {\n  name: 'UCameraOverlay',\n  props: {\n    devicePosition: { type: String, default: 'front' }, // 'front' | 'back'\n    showGuides: { type: Boolean, default: true },\n    showControls: { type: Boolean, default: true },\n    tips: { type: String, default: '请对齐人像轮廓' },\n    guideColor: { type: String, default: 'rgba(0,200,255,0.9)' },\n    crosshairColor: { type: String, default: 'rgba(255,255,255,0.6)' },\n    guideLineWidth: { type: Number, default: 4 }\n  },\n  data() {\n    return {\n      canvasId: 'overlay-' + this._uid,\n      currentDevice: this.devicePosition,\n      cameraCtx: null,\n      frameListener: null,\n      zoom: 1\n    }\n  },\n  watch: {\n    devicePosition(nv) {\n      this.currentDevice = nv\n    }\n  },\n  mounted() {},\n  beforeDestroy() {\n    try { this.frameListener && this.frameListener.stop && this.frameListener.stop() } catch(e){}\n  },\n  methods: {\n    onCamReady() {\n      // 仅在支付宝端相机 ready 后创建上下文\n      // #ifdef MP-ALIPAY\n      try {\n        this.cameraCtx = my.createCameraContext('ucam')\n      } catch(e) {\n        // 可能是非支付宝端或开发者工具不支持\n      }\n      this.$nextTick(() => {\n        if (this.showGuides) this.drawGuides()\n        this.startFrameLowFreq()\n      })\n      // #endif\n    },\n    drawGuides() {\n      // 使用 2D Canvas API 兼容写法（uni.createCanvasContext）\n      const ctx = uni.createCanvasContext(this.canvasId, this)\n      const query = uni.createSelectorQuery().in(this)\n      query.select('#' + this.canvasId).boundingClientRect()\n      query.exec(res => {\n        const rect = res && res[0]\n        if (!rect) return\n        const w = rect.width, h = rect.height\n        ctx.clearRect(0, 0, w, h)\n\n        // 人像头部椭圆（用缩放画圆近似）\n        const cx = w / 2, cy = h * 0.45\n        const rx = w * 0.18, ry = h * 0.14\n        ctx.save()\n        ctx.translate(cx, cy - h * 0.08)\n        ctx.scale(rx, ry)\n        ctx.setStrokeStyle(this.guideColor)\n        ctx.setLineWidth(this.guideLineWidth)\n        ctx.beginPath()\n        ctx.arc(0, 0, 1, 0, Math.PI * 2)\n        ctx.stroke()\n        ctx.restore()\n\n        // 肩部弧线\n        ctx.setStrokeStyle(this.guideColor)\n        ctx.setLineWidth(this.guideLineWidth)\n        ctx.beginPath()\n        ctx.moveTo(cx - w * 0.28, cy + h * 0.05)\n        ctx.bezierCurveTo(cx - w * 0.12, cy + h * 0.18, cx + w * 0.12, cy + h * 0.18, cx + w * 0.28, cy + h * 0.05)\n        ctx.stroke()\n\n        // 准星\n        ctx.setStrokeStyle(this.crosshairColor)\n        ctx.setLineWidth(1)\n        ctx.beginPath(); ctx.moveTo(cx - 20, cy); ctx.lineTo(cx + 20, cy); ctx.stroke()\n        ctx.beginPath(); ctx.moveTo(cx, cy - 20); ctx.lineTo(cx, cy + 20); ctx.stroke()\n\n        ctx.draw()\n      })\n    },\n    startFrameLowFreq() {\n      // 可选：低频取帧，避免掉帧\n      // #ifdef MP-ALIPAY\n      if (!this.cameraCtx || !this.cameraCtx.onCameraFrame) return\n      this.frameListener = this.cameraCtx.onCameraFrame((frame) => {\n        // 这里保留扩展点：可做亮度/人脸位置轻量分析（建议节流）\n      })\n      try { this.frameListener.start({ interval: 'low' }) } catch(e){}\n      // #endif\n    },\n    onShutter() {\n      // #ifdef MP-ALIPAY\n      if (!this.cameraCtx || !this.cameraCtx.takePhoto) {\n        uni.showToast({ title: '不支持拍照', icon: 'none' })\n        return\n      }\n      this.cameraCtx.takePhoto({\n        quality: 'high',\n        success: (res) => {\n          // res.tempImagePath\n          this.$emit('capture', res.tempImagePath)\n          uni.previewImage({ urls: [res.tempImagePath] })\n        },\n        fail: () => { uni.showToast({ title: '拍照失败', icon: 'none' }) }\n      })\n      // #endif\n    },\n    toggleDevice() {\n      const next = this.currentDevice === 'front' ? 'back' : 'front'\n      this.currentDevice = next\n      this.$emit('update:devicePosition', next)\n      // 重新绘制引导（尺寸不变无需重画，但为保险保留）\n      this.$nextTick(() => this.drawGuides())\n    },\n    zoomIn() {\n      this.zoom = Math.min(this.zoom + 0.2, 5)\n      // #ifdef MP-ALIPAY\n      if (this.cameraCtx && this.cameraCtx.setZoom) {\n        this.cameraCtx.setZoom({ zoom: this.zoom })\n      } else {\n        uni.showToast({ title: '端上不支持变焦', icon: 'none' })\n      }\n      // #endif\n    }\n  }\n}\n</script>\n\n<style scoped>\n.ucam-root {\n  position: relative;\n  width: 100vw;\n  height: 100vh;\n  overflow: hidden;\n  background: #000;\n}\n.ucam-camera {\n  position: absolute;\n  left: 0; right: 0; top: 0; bottom: 0;\n  height: 100vh;\n}\n.ucam-overlay {\n  position: absolute;\n  left: 0; right: 0; top: 0; bottom: 0;\n}\n.ucam-hud {\n  position: absolute;\n  left: 0; right: 0; bottom: 0;\n  padding: 24rpx;\n  display: flex; flex-direction: column; gap: 16rpx;\n}\n.ucam-tips {\n  align-self: center;\n  background: rgba(0,0,0,0.4);\n  color: #fff;\n  padding: 8rpx 16rpx;\n  border-radius: 9999rpx;\n  font-size: 28rpx;\n}\n.ucam-btns {\n  display: flex;\n  justify-content: center;\n  gap: 24rpx;\n}\n.ucam-btn {\n  background: rgba(0,0,0,0.55);\n  color: #fff;\n  padding: 16rpx 28rpx;\n  border-radius: 9999rpx;\n  font-size: 30rpx;\n}\n.ucam-notice {\n  position: absolute; left: 12rpx; right: 12rpx; bottom: 12rpx;\n  color: #fff; opacity: 0.8; text-align: center;\n}\n</style>\n","import Component from 'D:/workspace/ClientWorkArea/证照小程序/miniapp/zfb-uniapp/components/ucamera-overlay/ucamera-overlay.vue'\nmy.createComponent(Component)"],"names":["uni"],"mappings":"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"}